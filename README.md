# Tripwire Laravel

[![Latest Version on Packagist](https://img.shields.io/packagist/v/yormy/tripwire-laravel.svg?style=flat-square)](https://packagist.org/packages/yormy/tripwire-laravel)
[![Total Downloads](https://img.shields.io/packagist/dt/yormy/tripwire-laravel.svg?style=flat-square)](https://packagist.org/packages/yormy/tripwire-laravel)
![GitHub Workflow Status](https://img.shields.io/github/workflow/status/facade/ignition/run-php-tests?label=Tests)
![Alt text](./coverage.svg)

# Tripwire
```a wire stretched close to the ground, working a trap, explosion, or alarm when disturbed and serving to detect or prevent people or animals entering an area.```

```a comparatively weak military force employed as a first line of defence, engagement with which will trigger the intervention of stronger forces.```


# Installation
Tripwire-Laravel is an easy yet comprehensive and extendable way to add a security layer around laravel. All in order to prevent hackers getting into your system and frustrates the heck out of them while trying
```
composer require yormy/tripwire-laravel

php artisan migrate
```

# ExceptionsInspector
Add to your App/Exceptions/Hander
To allow taking action based on some system exceptions
```
public function render($request, Throwable $exception)
{
...
ExceptionInspector::inspect($exception);
...
```

# Middleware Setup
Order of middleware is when it trips, the first tripped wire will explore, the rest will not be checked

### Start of request cycle
```
    ChecksumCalculate::class, // need to be the very first in your middleware set before modifying any request item
    HoneypotsWire::class,
    ...
    ChecksumValidateWire::class, // validate that the frontend checksum matches the posted values
```

### General middleware
These 2 will block traffic based on their IP address or on the browser fingerprint generated by the frontend
Note for this to work you do not need to know the user. So it can be placed earlier in the request cycle
```
    TripwireBlockHandlerIp::class,
    TripwireBlockHandlerBrowser::class
```

### Api middleware
the middleware that all api traffic is flowing through
Note that these needs to be added after a user has been validated
add
```
TripwireBlockHandlerUser::class
```
This will block api traffic for blocked users  

Another thing you can do is to add TripwireBlockHandlerAll to the area where users are validated, and that will basically do a
TripwireBlockHandlerIp, TripwireBlockHandlerBrowser and TripwireBlockHandlerUser in one go and 1 query

### Web middleware
Note that these needs to be added after a user has been validated
add
```
TripwireBlockHandlerUser::class
```
This will block web traffic for blocked users



# Events
TripwireBlockedEvent => generic unspecified what or where but a block just happend
This is a good case to logout the current user and redirect to login page

TripwireBlockedIpEvent => when a block on ip is added


TripwireBlockedBrowserEvent

TripwireBlockedUserEvent

# Slack integrations
## Create slack incoming webhook
- open your slack application
- click apps
- find 'Incoming WebHooks' and add to slack
- select channel
- copy webhook and paste into your .env


# Catch Model Binding
When a hacker tries to change your routes and tries to access impproper missing models then you can catch this by

Add to your model that you want to protect
```
use TripwireModelBindingTrait
```

# Admin routes
In your routesfile specify the prefix/middelsware/group and register the tripwire routes
Route::TripwireAdminRoutes();
This way you can specify where the routes are in your path and namespaces and what middleware you want to apply

```
        Route::prefix('')
            ->middleware('api')
            ->group(function () {
                    Route::TripwireAdminRoutes();
            });
```


# Reseting keys
You can get a signed url for researched and developers to reset the logs.
Calling that url will clear the database of logs, in the config you can specify if they are soft or hard deleted.

Blocks that have the persistent flag set will not be removed. These flags need to be cleared before the blocks can be removed.
The use case is that sometimes you want to keep certain ips to remain blocked no matter what.
Admin first need to unpersist a block, and only then it can be deleted.

# config test
Run the following command to test your config and changes to make sure all test and checkers remain working
best is to have your application phpunit env set to use sqllite in memory
Test extensive to run a whole list of possible attack vectors to see if they are all blocked
```
./vendor/bin/phpunit ./vendor/yormy/tripwire-laravel/src/Tests --testdox --testsuite Main
./vendor/bin/phpunit ./vendor/yormy/tripwire-laravel/src/Tests --testdox --testsuite Extensive
```

## Warning
This is not a substitute for well validated and sanitized input.
The ruleset is not meant to be extensive to block everything, but to recognize and punish a hack attempt as soon as possible
Do you find that the ruleset is too restrictive or too loose, please let me know and I will adept them.
Provide a sample of the payload if it needs to be blocked or a valid user input that does not need to be blocked

# Installation tips
Although it works out of the box we suggest using it a while in training mode. This allows you to see what is going on without any request being blocked
If you turn on debug_mode then more data is recorded and after running it for a some time you can inspect the logs and blocks to see if there are any false positives
and modify the rules accordingly
If you notice false positives please let use know to so we can finetune the default config

# sales
Feedback ware
You pay with your feedback, When you use it you apparently like it, please let us know why you like it
If you remove it, you apparently dont like it, please let use know why
be active part of developing this with providing your feedback

Donation ware
I only have 24 hours a day, and besides a good night rest I need to eat and work to pay for my morgage. The time left is free time to relax and play
I developed this in my free time, I could have gone swimming, hiking, partying or whatever, but I decided to create this and make this available for you.
Hence I worked for free for you and your company. and that is fine.
However if you have or work in a commpany that has developers than I would higly appreciate a donation.
Ask yourself , could you or your development staff develop this level of tested code and features within 3 hours of their time. 
If not, please support me by donating 100 usd for my time and effort.
If you are a sole developer, without employing people or making money with your code, just use this package as you see fit.
But if you make money with it, or save money that you would have otherwise spend on other developers, please donate.

Pro Support
IF you want lifetime pro support, meaning faster merging of your changes/fixes that you submit. access to pre-release versions, vue frontend, 
faster response time to your issues. Please consider paying 1000, which is still much less than you would have spent if you hired a team to develop this package

Maybe vue frontend for sale? / access to git

## Changelog

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.

## Contributing

Please see [CONTRIBUTING](.github/CONTRIBUTING.md) for details.

## Security Vulnerabilities

Please review [our security policy](../../security/policy) on how to report security vulnerabilities.

## Credits

- [Yormy](https://gitlab.com/yormy)
- [All Contributors](../../contributors)

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
